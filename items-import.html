<!DOCTYPE html>
<html class="light" lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Импорт данных</title>
    <!-- PWA мета-теги -->
    <meta name="theme-color" content="#2563eb"/>
    <meta name="mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
    <link rel="manifest" href="manifest.json"/>
    <link rel="apple-touch-icon" href="assets/icons/icon-192.svg"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="assets/tailwind.css"/>
    <style>
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        body {
            min-height: max(884px, 100dvh);
            overscroll-behavior-y: none; 
        }
        
        /* Стили для сворачиваемых секций */
        .collapsible-section .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-section.expanded .section-content {
            max-height: 5000px;
        }
        .collapsible-section .chevron-icon {
            transition: transform 0.3s ease;
        }
        .collapsible-section.expanded .chevron-icon {
            transform: rotate(180deg);
        }
        
        /* Круговой прогресс-бар */
        .circular-progress-wrapper {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto;
        }
        .circular-progress-wrapper svg {
            transform: rotate(-90deg);
        }
        .circular-progress-wrapper circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
        }
        .circular-progress-wrapper .bg {
            stroke: #e2e8f0;
        }
        .dark .circular-progress-wrapper .bg {
            stroke: #334155;
        }
        .circular-progress-wrapper .progress {
            stroke: #2563eb;
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 0.3s ease;
        }
        .circular-progress-wrapper .percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.25rem;
            font-weight: 700;
            color: #2563eb;
        }
        .dark .circular-progress-wrapper .percentage {
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display antialiased text-slate-900 dark:text-slate-100 transition-colors duration-200">
    <div class="relative flex min-h-screen w-full flex-col max-w-md lg:max-w-7xl mx-auto bg-background-light dark:bg-background-dark overflow-hidden shadow-2xl lg:shadow-none border-x border-slate-200 dark:border-slate-800 lg:border-x-0">
        
        <!-- Header -->
        <div class="sticky top-0 z-50 bg-surface-light/95 dark:bg-surface-dark/95 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 transition-colors shadow-sm">
            <div class="flex items-center justify-between px-4 h-16">
                <button class="flex size-10 items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-800 dark:text-white transition-colors active:scale-95" data-navigate="items-management.html">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <div class="flex flex-col items-center">
                    <h1 class="text-base font-bold leading-tight">Импорт данных</h1>
                    <span class="text-xs text-slate-500 dark:text-slate-400 font-medium">Excel / CSV</span>
                </div>
                <button class="flex size-10 items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-800 dark:text-white transition-colors active:scale-95" id="help-btn">
                    <span class="material-symbols-outlined">help</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto pb-32 hide-scroll">
            
            <!-- Upload Area -->
            <div class="px-4 pt-6 pb-2" id="upload-area">
                <div class="relative group rounded-3xl border-2 border-dashed border-primary/40 bg-blue-50/50 dark:bg-blue-900/10 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors cursor-pointer p-6" id="drop-zone">
                    
                    <!-- Контент по умолчанию (выбор файла) -->
                    <div class="flex flex-col items-center justify-center text-center gap-3" id="upload-default-content">
                        <div class="size-14 rounded-2xl bg-white dark:bg-slate-800 shadow-sm flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-3xl">upload_file</span>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-900 dark:text-white" id="file-name">Выберите файл</h3>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1" id="file-info">Поддерживаются форматы: .xlsx, .xls, .csv</p>
                        </div>
                        <button class="mt-2 text-xs font-bold text-primary bg-white dark:bg-slate-800 py-2.5 px-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 hover:shadow-md transition-all active:scale-95" id="select-file-btn">
                            Выбрать файл
                        </button>
                    </div>
                    
                    <!-- Прогресс-бар (скрыт по умолчанию) -->
                    <div class="hidden flex flex-col items-center justify-center text-center gap-3" id="upload-progress-content">
                        <div class="circular-progress-wrapper">
                            <svg width="100" height="100">
                                <circle class="bg" cx="50" cy="50" r="45"></circle>
                                <circle class="progress" cx="50" cy="50" r="45" id="upload-progress-circle"></circle>
                            </svg>
                            <div class="percentage" id="upload-progress-percentage">0%</div>
                        </div>
                        <p class="text-sm text-slate-600 dark:text-slate-400" id="upload-progress-text">Загрузка файла...</p>
                    </div>
                    
                    <!-- Информация о загруженном файле (скрыта по умолчанию) -->
                    <div class="hidden flex flex-col items-center justify-center text-center gap-3" id="upload-success-content">
                        <div class="size-14 rounded-2xl bg-white dark:bg-slate-800 shadow-sm flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-3xl">description</span>
                        </div>
                        <div class="w-full">
                            <h3 class="font-bold text-slate-900 dark:text-white mb-1" id="upload-file-name">Файл загружен</h3>
                            <p class="text-xs text-slate-500 dark:text-slate-400" id="upload-file-stats">Новых: 0 | Ошибок: 0 | Дубликатов: 0</p>
                        </div>
                        <button class="mt-2 text-xs font-bold text-primary bg-white dark:bg-slate-800 py-2.5 px-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 hover:shadow-md transition-all active:scale-95" id="replace-file-btn">
                            Заменить файл
                        </button>
                    </div>
                    
                    <!-- Иконка успешной загрузки (скрыта по умолчанию) -->
                    <div class="absolute top-4 right-4 hidden" id="file-success-icon">
                        <span class="flex items-center justify-center size-6 rounded-full bg-green-500 text-white shadow-lg shadow-green-500/30">
                            <span class="material-symbols-outlined text-sm font-bold">check</span>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Filter Buttons (скрыты по умолчанию) -->
            <div class="sticky top-0 z-40 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-sm py-2 hidden" id="filter-buttons">
                <div class="flex gap-2 px-4 overflow-x-auto hide-scroll">
                    <button class="shrink-0 h-9 px-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-full text-xs font-bold shadow-md active:scale-95 transition-all flex items-center gap-2 filter-btn active" data-filter="all">
                        Все <span class="opacity-60 bg-white/20 dark:bg-black/10 px-1.5 py-0.5 rounded-md text-[10px]" id="count-all">0</span>
                    </button>
                    <button class="shrink-0 h-9 px-4 bg-white dark:bg-surface-dark text-red-600 dark:text-red-400 rounded-full text-xs font-bold shadow-sm border border-red-100 dark:border-red-900/30 active:bg-red-50 dark:active:bg-red-900/20 transition-colors flex items-center gap-2 filter-btn" data-filter="errors">
                        <span class="size-1.5 rounded-full bg-red-500 animate-pulse"></span>
                        Ошибки <span class="bg-red-100 dark:bg-red-900/40 px-1.5 py-0.5 rounded-md text-[10px]" id="count-errors">0</span>
                    </button>
                    <button class="shrink-0 h-9 px-4 bg-white dark:bg-surface-dark text-amber-600 dark:text-amber-400 rounded-full text-xs font-bold shadow-sm border border-amber-100 dark:border-amber-900/30 active:bg-amber-50 dark:active:bg-amber-900/20 transition-colors flex items-center gap-2 filter-btn" data-filter="duplicates">
                        Дубликаты <span class="bg-amber-100 dark:bg-amber-900/40 px-1.5 py-0.5 rounded-md text-[10px]" id="count-duplicates">0</span>
                    </button>
                </div>
            </div>

            <!-- Import Preview (контейнер для результатов) -->
            <div class="px-4 space-y-4 mt-2" id="import-preview">
                <!-- Здесь будут отображаться товары после загрузки файла -->
            </div>
        </div>

        <!-- Bottom Action Button -->
        <div class="absolute bottom-24 left-0 right-0 px-4 flex flex-col gap-3 justify-center z-[110] pointer-events-none">
            <!-- Сообщение об ошибках (скрыто по умолчанию) -->
            <div class="pointer-events-auto mx-auto bg-slate-800/90 dark:bg-white/90 backdrop-blur-md text-white dark:text-slate-900 text-xs px-4 py-2 rounded-full shadow-lg mb-2 items-center gap-2 animate-bounce hidden" style="animation-duration: 2s;" id="error-message">
                <span class="material-symbols-outlined text-[16px]">info</span>
                <span id="error-message-text">Исправьте ошибки перед сохранением</span>
            </div>
            
            <!-- Кнопка импорта -->
            <button class="pointer-events-auto w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-2xl py-4 shadow-xl shadow-slate-900/30 dark:shadow-black/50 flex items-center justify-center gap-3 font-bold text-base hover:scale-[1.02] active:scale-95 transition-all ring-4 ring-white dark:ring-slate-800 disabled:opacity-70 disabled:grayscale" disabled id="import-btn">
                <div class="size-6 rounded-full bg-slate-700 dark:bg-slate-200 flex items-center justify-center">
                    <span class="material-symbols-outlined text-[16px]">save</span>
                </div>
                Импортировать
            </button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 w-full bg-surface-light/95 dark:bg-surface-dark/95 backdrop-blur-lg border-t border-slate-200 dark:border-slate-800 pb-safe pt-2 px-6 h-[80px] z-[100] shadow-[0_-4px_20px_-4px_rgba(0,0,0,0.1)]">
        <div class="flex justify-between items-center max-w-md mx-auto h-full pb-4">
            <button class="flex flex-col items-center justify-center gap-1 w-16 text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300 transition-colors nav-button" data-navigate="index.html" data-nav-page="index">
                <span class="material-symbols-outlined text-[26px]">dashboard</span>
                <span class="text-[10px] font-medium">Главная</span>
            </button>
            <button class="flex flex-col items-center justify-center gap-1 w-16 text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300 transition-colors nav-button" data-navigate="items.html" data-nav-page="items">
                <span class="material-symbols-outlined text-[26px]">list_alt</span>
                <span class="text-[10px] font-medium">Список</span>
            </button>
            <button class="flex flex-col items-center justify-center gap-1 w-16 text-primary nav-button" data-navigate="items-management.html" data-nav-page="management">
                <span class="material-symbols-outlined filled-icon text-[26px]">settings</span>
                <span class="text-[10px] font-medium">Данные</span>
            </button>
            <button class="flex flex-col items-center justify-center gap-1 w-16 text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300 transition-colors nav-button" data-navigate="inventory-history.html" data-nav-page="history">
                <span class="material-symbols-outlined text-[26px]">bar_chart</span>
                <span class="text-[10px] font-medium">Отчеты</span>
            </button>
        </div>
    </nav>

    <!-- Модальное окно прогресса импорта -->
    <div class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm" id="import-progress-modal">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 mx-4 w-full max-w-sm">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white" id="import-progress-title">Импорт данных...</h3>
                <span class="text-lg font-bold text-primary" id="import-progress-percentage">0%</span>
            </div>
            <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2 overflow-hidden">
                <div class="h-full bg-primary rounded-full transition-all duration-300 relative overflow-hidden" id="import-progress-fill" style="width: 0%">
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-shimmer"></div>
                </div>
            </div>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-3" id="import-progress-subtitle">Пожалуйста, подождите</p>
        </div>
    </div>

    <!-- Модальное окно успешного импорта -->
    <div class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm" id="import-success-modal">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 mx-4 w-full max-w-sm text-center">
            <div class="size-16 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mx-auto mb-4">
                <span class="material-symbols-outlined text-4xl text-green-500">check_circle</span>
            </div>
            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Импорт завершён!</h3>
            <p class="text-slate-600 dark:text-slate-400 mb-6" id="import-success-message">Товары успешно импортированы</p>
            <div class="flex gap-3">
                <button class="flex-1 py-3 px-4 rounded-xl font-bold text-slate-700 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors" id="import-success-stay-btn">
                    Остаться
                </button>
                <button class="flex-1 py-3 px-4 rounded-xl font-bold text-white bg-primary hover:bg-blue-600 transition-colors" id="import-success-go-btn">
                    К товарам
                </button>
            </div>
        </div>
    </div>

    <style>
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .animate-shimmer {
            animation: shimmer 1.5s infinite;
        }
    </style>

    <!-- Подключение библиотеки для работы с Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Подключение библиотеки для работы с ZIP (для извлечения изображений из Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Подключение JavaScript модулей -->
    <script type="module" src="js/app.js?v=5.0"></script>
    <!-- Регистрация Service Worker для PWA -->
    <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Service Worker зарегистрирован:', reg.scope))
          .catch(err => console.log('Service Worker ошибка:', err));
      });
    }
    </script>
</body>
</html>

